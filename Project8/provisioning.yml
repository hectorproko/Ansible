#Comibing Creation of EC2 with EBS attaching them, Configuring NFS 
---
- name: Start
  hosts: localhost
  remote_user: Ansible
  gather_facts: false

  vars_files:
    - /etc/ansible/vars/info.yml

  tasks:
    - name: Choosing subnet 172.31.80.0/20
      set_fact:
        subnet: subnet-18872839 
        
    - name: Getting Default VPC
      amazon.aws.ec2_vpc_net_info:
        aws_access_key: "{{ aws_id }}"
        aws_secret_key: "{{ aws_key }}"
        region: "{{ aws_region }}"
        filters:
          "tag:Name": Default
      register: default_vpc

    - name: Create Security Group NFS/DB
      ec2_group:
        aws_access_key: "{{ aws_id }}"
        aws_secret_key: "{{ aws_key }}"
        region: "{{ aws_region }}"
        name: "Project7_NFS"
        description: "Security Group for NFS/DB server"
        vpc_id: "{{ default_vpc.vpcs[0].vpc_id }}"
        rules:
          - proto: "tcp" 
            ports: "22" #remote using ssh
            cidr_ip: 0.0.0.0/0
          - proto: "udp"
            ports: "111" #used with NFS
            cidr_ip: 172.31.80.0/20
          - proto: "tcp"
            ports: "111" #used with NFS
            cidr_ip: 172.31.80.0/20
          - proto: "tcp"
            ports: "2049" #NFS
            cidr_ip: 172.31.80.0/20
          - proto: "tcp"
            ports: "3306" #MYSQL
            cidr_ip: 172.31.80.0/20
      register: Project7_NFS

    - name: Create Security Group Web Server
      ec2_group:
        aws_access_key: "{{ aws_id }}"
        aws_secret_key: "{{ aws_key }}"
        region: "{{ aws_region }}"
        name: "Project8_web"
        description: "Security Group for Project 8 web servers"
        vpc_id: "{{ default_vpc.vpcs[0].vpc_id }}"
        rules:
          - proto: "tcp" 
            ports: "22" #remote using ssh
            cidr_ip: 0.0.0.0/0
          - proto: "tcp"
            ports: "80" #http
            cidr_ip: 172.31.80.0/20 #Needs to accept connections only from LB <<<<<<<<<<< change to single IP
      register: Project8_web
        
    - name: Find AMIs published by Red Hat (309956199498). Non-beta and x86
      ec2_ami_info:
        aws_access_key: "{{ aws_id }}"
        aws_secret_key: "{{ aws_key }}"
        region: "{{ aws_region }}"
        owners: 309956199498
        filters:
          architecture: x86_64
          name: RHEL-8*HVM-*
      register: amis

    #- name: Show AMI's
      #debug
        #var: amis

    - name: Get the latest one
      set_fact:
        latest_ami: "{{ amis.images | sort(attribute='creation_date') | last }}"

    - name: Provisioning NFS/DB Server
      ec2:
        aws_access_key: "{{ aws_id }}"
        aws_secret_key: "{{ aws_key }}"
        region: "{{ aws_region }}"
        image: "{{ latest_ami.image_id }}"
        instance_type: t2.micro
        key_name: "{{ ssh_keyname }}"
        count: 1
        state: present
        group_id: "{{ Project7_NFS.group_id }}"
        wait: yes
        vpc_subnet_id: "{{ subnet }}"
        assign_public_ip: yes
        instance_tags:
          Name: NFS
      register: ec2nfs
      
    - name: Setting facts so that they will be persisted in the fact cache
      set_fact:
        nfsIP: ec2nfs.instances[0].private_ip

    - name: Output web1 Private IP
      debug:
        var: "{{ nfsIP }}"
        
    - name: Create EBS
      ec2_vol:
        aws_access_key: "{{ aws_id }}"
        aws_secret_key: "{{ aws_key }}"
        region: "{{ aws_region }}"
        volume_size: 10
        volume_type: gp2
        zone: us-east-1c
        delete_on_termination: true
        name: "{{ item.name }}"
        device_name: "{{ item.mapping }}"
        instance: "{{ ec2nfs.instance_ids[0] }}" 
        state: present
      loop:
        - { name: 'Project7Ansible1', mapping: '/dev/xvdf' }
        - { name: 'Project7Ansible2', mapping: '/dev/xvdg' }
        - { name: 'Project7Ansible3', mapping: '/dev/xvdh' }
      register: ansibleEBS

    # - name: Output Private IP
      # ansible.builtin.debug:
        # msg: 'Trouble shooting IP string {{ ec2nfs.instances[0].private_ip }}'
        
        
    - name: WebServer
      ec2:
        aws_access_key: "{{ aws_id }}"
        aws_secret_key: "{{ aws_key }}"
        region: "{{ aws_region }}"
        image: "{{ latest_ami.image_id }}"
        instance_type: t2.micro
        key_name: "{{ ssh_keyname }}"
        count: 2 #number of instnaces to launch
        state: present
        group_id: "{{ Project8_web.group_id }}" 
        wait: yes
        vpc_subnet_id: "{{ subnet }}"
        assign_public_ip: yes
        instance_tags:
          Name: web7 # 7 for project 7
      register: ec2web
 
    - name: Setting facts so that they will be persisted in the fact cache
      set_fact:
        webIP: ec2web.instances[0].private_ip
        
    - name: Setting facts so that they will be persisted in the fact cache
      set_fact:
        webIP2: ec2web.instances[1].private_ip
        
    - name: Output web1 Private IP
      debug:
        var: "{{ webIP }}"
        
    - name: Output web2 Private IP
      debug:
        var: "{{ webIP2 }}"
 
       #Project 8 Addition, Load Balancer with security group
    - name: Create Security Group Apache LB
      ec2_group:
        aws_access_key: "{{ aws_id }}"
        aws_secret_key: "{{ aws_key }}"
        region: "{{ aws_region }}"
        name: "Project8_LB"
        description: "Security Group for Apache LB server"
        vpc_id: "{{ default_vpc.vpcs[0].vpc_id }}"
        rules:
          - proto: "tcp" 
            ports: "22" #remote using ssh
            cidr_ip: 0.0.0.0/0
          - proto: "tcp"
            ports: "80" #http
            cidr_ip: 0.0.0.0/0
      register: Project8_LB
      
    - name: Ubuntu Apache LB
      ec2:
        aws_access_key: "{{ aws_id }}"
        aws_secret_key: "{{ aws_key }}"
        region: "{{ aws_region }}"
        image: ami-04505e74c0741db8d # Ubuntu 64-bit x86
        instance_type: t2.micro
        key_name: "{{ ssh_keyname }}"
        count: 1
        state: present
        group_id: "{{ Project8_LB.group_id }}"
        wait: yes
        vpc_subnet_id: "{{ subnet }}"
        assign_public_ip: yes
        instance_tags:
          Name: LB
      register: ec2nfs
      
    #Inconsistent results with this method, using bash sript for this
    # - name: Calling NFS/WEB configuration
      # command: sudo ansible-playbook NFS+WEB_configure.yml --extra-vars "privateIP={{ ec2nfs.instances[0].private_ip }}" 
      # command: sudo ansible-playbook NFS+WEB_configure.yml --extra-vars "privateIP={{ ec2nfs.instances[0].private_ip }}" 
